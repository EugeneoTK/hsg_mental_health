<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HSG Mental Health Screening Toolkit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: only light;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        line-height: 1.6;
        --color-bg: #f4f6fb;
        --color-surface: #ffffff;
        --color-border: #dce1ee;
        --color-outline: #b5c5f4;
        --color-text: #1f2433;
        --color-muted: #5b6273;
        --color-heading: #101a33;
        --color-primary: #0f6bd6;
        --color-primary-soft: rgba(0, 99, 204, 0.14);
        --color-accent: #ec407a;
        --color-anxiety: #845ef7;
        --color-depression: #f97316;
        --color-success: #0f5132;
        --color-warning: #b42318;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--color-bg);
        color: var(--color-text);
      }

      main.layout {
        max-width: 1120px;
        margin: 0 auto;
        padding: 48px 24px 96px;
      }

      .page-header {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 24px;
        align-items: center;
        margin-bottom: 32px;
      }

      .page-header img.logo {
        width: clamp(96px, 14vw, 128px);
        height: auto;
      }

      .page-header .title-group {
        display: grid;
        gap: 6px;
      }

      .page-header .pretitle {
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--color-primary);
        margin: 0;
      }

      .page-header h1 {
        margin: 0;
        font-size: clamp(1.85rem, 3.4vw, 2.6rem);
        color: var(--color-heading);
      }

      .page-header .lede {
        margin: 0;
        color: var(--color-muted);
        font-size: 1rem;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
        margin-bottom: 28px;
      }

      .info-card {
        background: var(--color-surface);
        border-radius: 18px;
        border: 1px solid var(--color-border);
        padding: 20px 24px;
        box-shadow: 0 24px 60px rgba(15, 27, 55, 0.08);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .info-card h2 {
        margin: 0;
        font-size: 1rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--color-primary);
      }

      .info-card p,
      .info-card li {
        margin: 0;
        font-size: 0.95rem;
      }

      .info-card ul {
        margin: 0;
        padding-left: 18px;
        color: var(--color-text);
      }

      .last-updated {
        margin-top: auto;
        font-size: 0.9rem;
        color: var(--color-muted);
      }

      .status-banner {
        display: none;
        gap: 12px;
        align-items: flex-start;
        background: var(--color-primary-soft);
        border: 1px solid var(--color-outline);
        padding: 16px 20px;
        border-radius: 16px;
        margin-bottom: 24px;
      }

      .status-banner.show {
        display: grid;
        grid-template-columns: auto 1fr;
      }

      .status-banner .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--color-primary);
        margin-top: 6px;
      }

      .status-banner strong {
        display: block;
        margin-bottom: 4px;
      }

      form {
        display: grid;
        gap: 28px;
      }

      .question-card {
        background: var(--color-surface);
        border-radius: 22px;
        border: 1px solid var(--color-border);
        box-shadow: 0 24px 70px rgba(15, 27, 55, 0.12);
        padding: 28px 28px 32px;
        display: grid;
        gap: 18px;
      }

      .followup-section {
        display: grid;
        gap: 12px;
      }

      .followup-section.is-hidden {
        display: none;
      }

      .followup-label {
        margin: 4px 20px 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-muted);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .followup-label .scale-chip {
        margin-left: 0;
      }

      .followup-title {
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .question-card.expanded {
        border-color: rgba(15, 107, 214, 0.4);
        box-shadow: 0 32px 80px rgba(15, 107, 214, 0.18);
      }

      .question-card__head h2 {
        margin: 0 0 6px;
        font-size: clamp(1.25rem, 2.4vw, 1.6rem);
        color: var(--color-heading);
      }

      .question-card__head p {
        margin: 0;
        color: var(--color-muted);
        font-size: 0.97rem;
      }

      .scale-table {
        border: 1px solid var(--color-border);
        border-radius: 18px;
        overflow: hidden;
      }

      .scale-header,
      fieldset.question-row {
        display: grid;
        grid-template-columns: minmax(0, 1.65fr) repeat(4, minmax(0, 1fr));
        align-items: stretch;
      }

      .scale-header {
        background: rgba(15, 107, 214, 0.06);
        color: var(--color-heading);
        font-size: 0.95rem;
        font-weight: 600;
      }

      .scale-header > div {
        padding: 16px 18px;
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 2px;
        text-align: center;
      }

      .scale-header > div:first-child {
        text-align: left;
      }

      .scale-header > div:last-child,
      fieldset.question-row > label:last-of-type {
        border-right: none;
      }

      .scale-header .score {
        font-size: 1.1rem;
        color: var(--color-primary);
      }

      fieldset.question-row {
        margin: 0;
        padding: 0;
        border: 0;
        border-top: 1px solid var(--color-border);
        background: var(--color-surface);
      }

      fieldset.question-row.is-hidden {
        display: none;
      }

      fieldset.question-row legend {
        grid-column: 1;
        padding: 18px 20px;
        font-weight: 600;
        font-size: 0.98rem;
        color: var(--color-heading);
      }

      fieldset.question-row legend .scale-chip {
        margin-left: 10px;
        font-size: 0.7rem;
      }

      fieldset.question-row label {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px 12px;
        border-right: 1px solid var(--color-border);
        cursor: pointer;
        transition: background 0.2s ease;
      }

      fieldset.question-row label:hover {
        background: rgba(15, 107, 214, 0.08);
      }

      fieldset.question-row input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .choice {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        color: var(--color-heading);
      }

      .choice-score {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--color-border);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
        transition: all 0.2s ease;
        background: #f8faff;
      }

      input[type="radio"]:checked + .choice .choice-score {
        border-color: var(--color-primary);
        background: var(--color-primary);
        color: #fff;
        box-shadow: 0 8px 18px rgba(15, 107, 214, 0.28);
      }

      .choice-text {
        font-size: 0.75rem;
        color: var(--color-muted);
      }

      .scale-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #fff;
        background: var(--color-primary);
      }

      .scale-chip.depression {
        background: var(--color-depression);
      }

      .scale-chip.anxiety {
        background: var(--color-anxiety);
      }

      .score-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .summary-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 16px;
        padding: 16px 18px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        display: grid;
        gap: 4px;
      }

      .summary-card h3 {
        margin: 0;
        font-size: 0.9rem;
        color: var(--color-muted);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .summary-card .score {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--color-heading);
      }

      .summary-card .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(15, 107, 214, 0.1);
        color: var(--color-primary);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.78rem;
        font-weight: 600;
      }

      .summary-card .badge.active {
        background: rgba(15, 107, 214, 0.18);
      }

      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      button[type="submit"],
      .secondary-btn {
        border: none;
        border-radius: 999px;
        padding: 12px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }

      button[type="submit"] {
        background: var(--color-primary);
        color: #fff;
        box-shadow: 0 14px 30px rgba(15, 107, 214, 0.25);
      }

      button[type="submit"]:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 34px rgba(15, 107, 214, 0.32);
      }

      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .secondary-btn {
        background: transparent;
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
        display: none;
      }

      .secondary-btn.clear {
        border-color: var(--color-warning);
        color: var(--color-warning);
      }

      #result {
        margin-top: 12px;
      }

      #result > div {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 16px;
        padding: 18px;
        margin-bottom: 16px;
        box-shadow: 0 16px 40px rgba(15, 27, 55, 0.08);
      }

      h3.section-head {
        margin: 32px 0 12px;
        font-size: 1.2rem;
        color: var(--color-heading);
      }

      .api-error,
      .api-success {
        border-radius: 12px;
        padding: 14px 16px;
        margin-top: 12px;
        font-size: 0.95rem;
      }

      .api-error {
        background: rgba(180, 35, 24, 0.1);
        border: 1px solid rgba(180, 35, 24, 0.24);
        color: var(--color-warning);
      }

      .api-success {
        background: rgba(15, 81, 50, 0.1);
        border: 1px solid rgba(15, 81, 50, 0.2);
        color: var(--color-success);
      }

      .rate-card {
        margin-top: 36px;
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        border-radius: 20px;
        padding: 18px 20px;
        box-shadow: 0 18px 40px rgba(15, 27, 55, 0.08);
        display: grid;
        gap: 12px;
      }

      .rate-head {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .rating {
        display: inline-flex;
        flex-direction: row-reverse;
        gap: 4px;
      }

      .rating input {
        display: none;
      }

      .rating label {
        font-size: 28px;
        line-height: 1;
        color: #c7cad6;
        cursor: pointer;
        transition: color 0.15s ease;
      }

      .rating input:checked ~ label,
      .rating label:hover,
      .rating label:hover ~ label {
        color: #f5b301;
      }

      .rate-thanks {
        display: none;
        font-size: 0.9rem;
        color: var(--color-success);
        margin-left: auto;
      }

      .rate-thanks.show {
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }

      .tick {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid var(--color-success);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
      }

      .target-highlight {
        background: rgba(15, 107, 214, 0.08);
        border-left: 4px solid var(--color-primary);
        padding: 10px 14px;
        border-radius: 10px;
      }

      .target-highlight.risk-level {
        color: var(--color-primary);
        font-weight: 600;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      @media (max-width: 900px) {
        .scale-header,
        fieldset.question-row {
          grid-template-columns: minmax(0, 1.5fr) repeat(4, minmax(0, 0.9fr));
        }
      }

      @media (max-width: 720px) {
        .page-header {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .page-header img.logo {
          margin: 0 auto;
        }

        .scale-table {
          overflow-x: auto;
        }

        .scale-header,
        fieldset.question-row {
          min-width: 640px;
        }

        .form-actions {
          flex-direction: column;
          align-items: stretch;
        }

        button[type="submit"],
        .secondary-btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <header class="page-header">
        <img src="./hsg_edited.avif" alt="Healthier SG" class="logo" />
        <div class="title-group">
          <p class="pretitle">Revised toolkit</p>
          <h1>HSG Mental Health Tiered Screening Toolkit</h1>
          <p class="lede">
            Administer PHQ-4, PHQ-9 and GAD-7 seamlessly. Follow-up rows unlock instantly when the
            PHQ-4 sub-scores indicate further screening is required.
          </p>
        </div>
      </header>

      <section class="info-grid">
        <article class="info-card">
          <h2>Introduction</h2>
          <p>
            This toolkit administers the Patient Health Questionnaire (PHQ) and Generalized Anxiety
            Disorder (GAD) screening instruments in one streamlined workflow. Begin with the core
            <strong>PHQ-4</strong>; additional PHQ-9 or GAD-7 items appear automatically when the
            corresponding sub-scores meet the escalation threshold.
          </p>
        </article>

        <article class="info-card">
          <h2>Disclaimer</h2>
          <p>
            These digital tools support clinical decision making but do not replace a comprehensive
            clinical assessment. Interpret all results alongside clinical judgement and organisational
            protocols.
          </p>
        </article>

        <article class="info-card">
          <h2>References</h2>
          <ul>
            <li>Kroenke K. et al. (2009). The PHQ-4 as a brief measure of anxiety and depression.</li>
            <li>Spitzer R. et al. (2006). A brief measure for assessing generalized anxiety disorder.</li>
            <li>Kroenke K. et al. (2001). The PHQ-9: Validity of a brief depression severity measure.</li>
          </ul>
          <p class="last-updated">Last updated: April 2024</p>
        </article>
      </section>

      <div class="status-banner" id="statusBanner" role="status" aria-live="polite">
        <span class="status-dot" aria-hidden="true"></span>
        <div>
          <strong>Additional screening unlocked</strong>
          <span>
            Based on the first four responses, we've surfaced the remaining PHQ-9 and/or GAD-7 items for
            you automatically.
          </span>
        </div>
      </div>

      <form id="mhForm" name="mhForm" novalidate>
        <section class="question-card" id="phq9Section" aria-labelledby="phq9Heading">
          <div class="question-card__head">
            <h2 id="phq9Heading">Patient Health Questionnaire-9 (PHQ-9)</h2>
            <p>
              Over the last 2 weeks, how often have you been bothered by the following problems? Complete
              items 1 and 2 first; the remaining questions will expand automatically when the PHQ-4
              depression sub-score is 3 or higher.
            </p>
          </div>
          <div class="scale-table" role="table" aria-describedby="phq9Heading">
            <div class="scale-header" role="row">
              <div role="columnheader">Question</div>
              <div role="columnheader" id="option-0">
                <span class="score">0</span>
                <span class="label">Not at all</span>
              </div>
              <div role="columnheader" id="option-1">
                <span class="score">1</span>
                <span class="label">Several days</span>
              </div>
              <div role="columnheader" id="option-2">
                <span class="score">2</span>
                <span class="label">More than half the days</span>
              </div>
              <div role="columnheader" id="option-3">
                <span class="score">3</span>
                <span class="label">Nearly every day</span>
              </div>
            </div>

            <fieldset class="question-row" data-question="phq9_q1" data-scale="phq9" data-subscale="depression" role="rowgroup">
              <legend id="phq9_q1_label">
                1. Little interest or pleasure in doing things
                <span class="scale-chip depression">PHQ-4 · PHQ-9</span>
              </legend>
              <label>
                <input type="radio" name="phq9_q1" value="0" required aria-labelledby="phq9_q1_label option-0" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">0</span>
                  <span class="choice-text sr-only">Not at all</span>
                </span>
              </label>
              <label>
                <input type="radio" name="phq9_q1" value="1" aria-labelledby="phq9_q1_label option-1" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">1</span>
                  <span class="choice-text sr-only">Several days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="phq9_q1" value="2" aria-labelledby="phq9_q1_label option-2" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">2</span>
                  <span class="choice-text sr-only">More than half the days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="phq9_q1" value="3" aria-labelledby="phq9_q1_label option-3" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">3</span>
                  <span class="choice-text sr-only">Nearly every day</span>
                </span>
              </label>
            </fieldset>

            <fieldset class="question-row" data-question="phq9_q2" data-scale="phq9" data-subscale="depression" role="rowgroup">
              <legend id="phq9_q2_label">
                2. Feeling down, depressed, or hopeless
                <span class="scale-chip depression">PHQ-4 · PHQ-9</span>
              </legend>
              <label>
                <input type="radio" name="phq9_q2" value="0" required aria-labelledby="phq9_q2_label option-0" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">0</span>
                  <span class="choice-text sr-only">Not at all</span>
                </span>
              </label>
              <label>
                <input type="radio" name="phq9_q2" value="1" aria-labelledby="phq9_q2_label option-1" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">1</span>
                  <span class="choice-text sr-only">Several days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="phq9_q2" value="2" aria-labelledby="phq9_q2_label option-2" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">2</span>
                  <span class="choice-text sr-only">More than half the days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="phq9_q2" value="3" aria-labelledby="phq9_q2_label option-3" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">3</span>
                  <span class="choice-text sr-only">Nearly every day</span>
                </span>
              </label>
            </fieldset>

            <div class="followup-section is-hidden" data-followup-group="phq9" aria-hidden="true">
              <p class="followup-label">
                <span class="followup-title">PHQ-9 follow-up items</span>
                <span class="scale-chip depression">PHQ-9</span>
              </p>

              <fieldset class="question-row is-hidden" data-question="phq9_q3" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q3_label">3. Trouble falling or staying asleep, or sleeping too much</legend>
                <label>
                  <input type="radio" name="phq9_q3" value="0" aria-labelledby="phq9_q3_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q3" value="1" aria-labelledby="phq9_q3_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q3" value="2" aria-labelledby="phq9_q3_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q3" value="3" aria-labelledby="phq9_q3_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="phq9_q4" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q4_label">4. Feeling tired or having little energy</legend>
                <label>
                  <input type="radio" name="phq9_q4" value="0" aria-labelledby="phq9_q4_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q4" value="1" aria-labelledby="phq9_q4_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q4" value="2" aria-labelledby="phq9_q4_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q4" value="3" aria-labelledby="phq9_q4_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="phq9_q5" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q5_label">5. Poor appetite or overeating</legend>
                <label>
                  <input type="radio" name="phq9_q5" value="0" aria-labelledby="phq9_q5_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q5" value="1" aria-labelledby="phq9_q5_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q5" value="2" aria-labelledby="phq9_q5_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q5" value="3" aria-labelledby="phq9_q5_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="phq9_q6" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q6_label">6. Feeling bad about yourself — or that you are a failure or have let yourself or your family down</legend>
                <label>
                  <input type="radio" name="phq9_q6" value="0" aria-labelledby="phq9_q6_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q6" value="1" aria-labelledby="phq9_q6_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q6" value="2" aria-labelledby="phq9_q6_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q6" value="3" aria-labelledby="phq9_q6_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="phq9_q7" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q7_label">7. Trouble concentrating on things, such as reading the newspaper or watching television</legend>
                <label>
                  <input type="radio" name="phq9_q7" value="0" aria-labelledby="phq9_q7_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q7" value="1" aria-labelledby="phq9_q7_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q7" value="2" aria-labelledby="phq9_q7_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q7" value="3" aria-labelledby="phq9_q7_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="phq9_q8" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q8_label">8. Moving or speaking so slowly that other people could have noticed? Or the opposite — being so fidgety or restless that you have been moving around a lot more than usual</legend>
                <label>
                  <input type="radio" name="phq9_q8" value="0" aria-labelledby="phq9_q8_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q8" value="1" aria-labelledby="phq9_q8_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q8" value="2" aria-labelledby="phq9_q8_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q8" value="3" aria-labelledby="phq9_q8_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="phq9_q9" data-scale="phq9" data-subscale="depression" role="rowgroup" aria-hidden="true">
                <legend id="phq9_q9_label">
                  9. Thoughts that you would be better off dead, or of hurting yourself in some way
                  <span class="scale-chip depression">Safety check</span>
                </legend>
                <label>
                  <input type="radio" name="phq9_q9" value="0" aria-labelledby="phq9_q9_label option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q9" value="1" aria-labelledby="phq9_q9_label option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q9" value="2" aria-labelledby="phq9_q9_label option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="phq9_q9" value="3" aria-labelledby="phq9_q9_label option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>
            </div>
          </div>
        </section>

        <section class="question-card" id="gad7Section" aria-labelledby="gad7Heading">
          <div class="question-card__head">
            <h2 id="gad7Heading">Generalized Anxiety Disorder 7-item (GAD-7)</h2>
            <p>
              Over the last 2 weeks, how often have you been bothered by the following problems? Items 1
              and 2 form the PHQ-4 anxiety screen. The remaining GAD-7 rows unlock when the sub-score is 3
              or above.
            </p>
          </div>
          <div class="scale-table" role="table" aria-describedby="gad7Heading">
            <div class="scale-header" role="row">
              <div role="columnheader">Question</div>
              <div role="columnheader" id="gad-option-0">
                <span class="score">0</span>
                <span class="label">Not at all</span>
              </div>
              <div role="columnheader" id="gad-option-1">
                <span class="score">1</span>
                <span class="label">Several days</span>
              </div>
              <div role="columnheader" id="gad-option-2">
                <span class="score">2</span>
                <span class="label">More than half the days</span>
              </div>
              <div role="columnheader" id="gad-option-3">
                <span class="score">3</span>
                <span class="label">Nearly every day</span>
              </div>
            </div>

            <fieldset class="question-row" data-question="gad7_q1" data-scale="gad7" data-subscale="anxiety" role="rowgroup">
              <legend id="gad7_q1_label">
                1. Feeling nervous, anxious, or on edge
                <span class="scale-chip anxiety">PHQ-4 · GAD-7</span>
              </legend>
              <label>
                <input type="radio" name="gad7_q1" value="0" required aria-labelledby="gad7_q1_label gad-option-0" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">0</span>
                  <span class="choice-text sr-only">Not at all</span>
                </span>
              </label>
              <label>
                <input type="radio" name="gad7_q1" value="1" aria-labelledby="gad7_q1_label gad-option-1" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">1</span>
                  <span class="choice-text sr-only">Several days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="gad7_q1" value="2" aria-labelledby="gad7_q1_label gad-option-2" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">2</span>
                  <span class="choice-text sr-only">More than half the days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="gad7_q1" value="3" aria-labelledby="gad7_q1_label gad-option-3" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">3</span>
                  <span class="choice-text sr-only">Nearly every day</span>
                </span>
              </label>
            </fieldset>

            <fieldset class="question-row" data-question="gad7_q2" data-scale="gad7" data-subscale="anxiety" role="rowgroup">
              <legend id="gad7_q2_label">
                2. Not being able to stop or control worrying
                <span class="scale-chip anxiety">PHQ-4 · GAD-7</span>
              </legend>
              <label>
                <input type="radio" name="gad7_q2" value="0" required aria-labelledby="gad7_q2_label gad-option-0" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">0</span>
                  <span class="choice-text sr-only">Not at all</span>
                </span>
              </label>
              <label>
                <input type="radio" name="gad7_q2" value="1" aria-labelledby="gad7_q2_label gad-option-1" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">1</span>
                  <span class="choice-text sr-only">Several days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="gad7_q2" value="2" aria-labelledby="gad7_q2_label gad-option-2" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">2</span>
                  <span class="choice-text sr-only">More than half the days</span>
                </span>
              </label>
              <label>
                <input type="radio" name="gad7_q2" value="3" aria-labelledby="gad7_q2_label gad-option-3" />
                <span class="choice">
                  <span class="choice-score" aria-hidden="true">3</span>
                  <span class="choice-text sr-only">Nearly every day</span>
                </span>
              </label>
            </fieldset>

            <div class="followup-section is-hidden" data-followup-group="gad7" aria-hidden="true">
              <p class="followup-label">
                <span class="followup-title">GAD-7 follow-up items</span>
                <span class="scale-chip anxiety">GAD-7</span>
              </p>

              <fieldset class="question-row is-hidden" data-question="gad7_q3" data-scale="gad7" data-subscale="anxiety" role="rowgroup" aria-hidden="true">
                <legend id="gad7_q3_label">3. Worrying too much about different things</legend>
                <label>
                  <input type="radio" name="gad7_q3" value="0" aria-labelledby="gad7_q3_label gad-option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q3" value="1" aria-labelledby="gad7_q3_label gad-option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q3" value="2" aria-labelledby="gad7_q3_label gad-option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q3" value="3" aria-labelledby="gad7_q3_label gad-option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="gad7_q4" data-scale="gad7" data-subscale="anxiety" role="rowgroup" aria-hidden="true">
                <legend id="gad7_q4_label">4. Trouble relaxing</legend>
                <label>
                  <input type="radio" name="gad7_q4" value="0" aria-labelledby="gad7_q4_label gad-option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q4" value="1" aria-labelledby="gad7_q4_label gad-option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q4" value="2" aria-labelledby="gad7_q4_label gad-option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q4" value="3" aria-labelledby="gad7_q4_label gad-option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="gad7_q5" data-scale="gad7" data-subscale="anxiety" role="rowgroup" aria-hidden="true">
                <legend id="gad7_q5_label">5. Being so restless that it is hard to sit still</legend>
                <label>
                  <input type="radio" name="gad7_q5" value="0" aria-labelledby="gad7_q5_label gad-option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q5" value="1" aria-labelledby="gad7_q5_label gad-option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q5" value="2" aria-labelledby="gad7_q5_label gad-option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q5" value="3" aria-labelledby="gad7_q5_label gad-option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="gad7_q6" data-scale="gad7" data-subscale="anxiety" role="rowgroup" aria-hidden="true">
                <legend id="gad7_q6_label">6. Becoming easily annoyed or irritable</legend>
                <label>
                  <input type="radio" name="gad7_q6" value="0" aria-labelledby="gad7_q6_label gad-option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q6" value="1" aria-labelledby="gad7_q6_label gad-option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q6" value="2" aria-labelledby="gad7_q6_label gad-option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q6" value="3" aria-labelledby="gad7_q6_label gad-option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>

              <fieldset class="question-row is-hidden" data-question="gad7_q7" data-scale="gad7" data-subscale="anxiety" role="rowgroup" aria-hidden="true">
                <legend id="gad7_q7_label">7. Feeling afraid as if something awful might happen</legend>
                <label>
                  <input type="radio" name="gad7_q7" value="0" aria-labelledby="gad7_q7_label gad-option-0" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">0</span>
                    <span class="choice-text sr-only">Not at all</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q7" value="1" aria-labelledby="gad7_q7_label gad-option-1" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">1</span>
                    <span class="choice-text sr-only">Several days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q7" value="2" aria-labelledby="gad7_q7_label gad-option-2" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">2</span>
                    <span class="choice-text sr-only">More than half the days</span>
                  </span>
                </label>
                <label>
                  <input type="radio" name="gad7_q7" value="3" aria-labelledby="gad7_q7_label gad-option-3" />
                  <span class="choice">
                    <span class="choice-score" aria-hidden="true">3</span>
                    <span class="choice-text sr-only">Nearly every day</span>
                  </span>
                </label>
              </fieldset>
            </div>
          </div>
        </section>

        <div class="score-summary" id="scoreSummary" aria-live="polite"></div>

        <div class="form-actions">
          <button type="submit" id="submitBtn">Generate summary</button>
          <button type="button" class="secondary-btn" id="copyBtn">Copy summary</button>
          <button type="button" class="secondary-btn clear" id="clearBtn" aria-label="Clear all inputs and results">Clear all</button>
        </div>
      </form>

      <section id="result" aria-live="polite"></section>

      <div class="rate-card" id="rateCard" aria-labelledby="rateTitle">
        <div class="rate-head">
          <div id="rateTitle" class="rate-title">Help us improve: Was this screening flow helpful?</div>
          <div class="rating" role="radiogroup" aria-label="5 star rating">
            <input type="radio" id="star5" name="rating" value="5" aria-label="5 stars" /><label for="star5">★</label>
            <input type="radio" id="star4" name="rating" value="4" aria-label="4 stars" /><label for="star4">★</label>
            <input type="radio" id="star3" name="rating" value="3" aria-label="3 stars" /><label for="star3">★</label>
            <input type="radio" id="star2" name="rating" value="2" aria-label="2 stars" /><label for="star2">★</label>
            <input type="radio" id="star1" name="rating" value="1" aria-label="1 star" /><label for="star1">★</label>
          </div>
          <div class="rate-thanks" id="rateThanks"><span class="tick">✓</span> Thanks for your feedback!</div>
        </div>
        <div class="note">Your star rating is anonymous. It helps us improve the toolkit.</div>
      </div>
    </main>
    <script>
      const PHQ4_DEPRESSION = ['phq9_q1','phq9_q2'];
      const PHQ4_ANXIETY = ['gad7_q1','gad7_q2'];
      const PHQ9_FULL = ['phq9_q1','phq9_q2','phq9_q3','phq9_q4','phq9_q5','phq9_q6','phq9_q7','phq9_q8','phq9_q9'];
      const GAD7_FULL = ['gad7_q1','gad7_q2','gad7_q3','gad7_q4','gad7_q5','gad7_q6','gad7_q7'];

      const severityBands = {
        phq9: [
          { max: 4, label: 'Minimal depression'},
          { max: 9, label: 'Mild depression'},
          { max: 14, label: 'Moderate depression'},
          { max: 19, label: 'Moderately severe depression'},
          { max: Infinity, label: 'Severe depression'}
        ],
        gad7: [
          { max: 4, label: 'Minimal anxiety'},
          { max: 9, label: 'Mild anxiety'},
          { max: 14, label: 'Moderate anxiety'},
          { max: Infinity, label: 'Severe anxiety'}
        ]
      };

      const mhForm = document.getElementById('mhForm');
      const statusBanner = document.getElementById('statusBanner');
      const scoreSummary = document.getElementById('scoreSummary');
      const resultDiv = document.getElementById('result');
      const copyBtn = document.getElementById('copyBtn');
      const clearBtn = document.getElementById('clearBtn');
      const submitBtn = document.getElementById('submitBtn');
      const phq9Section = document.getElementById('phq9Section');
      const gad7Section = document.getElementById('gad7Section');

      function sumScore(ids){
        return ids.reduce((acc,id)=>{
          const selected = mhForm.querySelector(`input[name="${id}"]:checked`);
          return acc + (selected ? Number(selected.value) : 0);
        },0);
      }

      function setFollowupVisibility(ids, shouldShow){
        if(!ids.length) return;

        const groupName = ids[0].split('_')[0];
        if(groupName){
          const group = mhForm.querySelector(`[data-followup-group="${groupName}"]`);
          if(group){
            if(shouldShow){
              group.classList.remove('is-hidden');
              group.removeAttribute('aria-hidden');
            }else{
              group.classList.add('is-hidden');
              group.setAttribute('aria-hidden','true');
            }
          }
        }

        ids.forEach(id=>{
          const row = mhForm.querySelector(`[data-question="${id}"]`);
          if(!row) return;
          const radios = Array.from(row.querySelectorAll('input[type="radio"]'));
          if(shouldShow){
            row.classList.remove('is-hidden');
            row.removeAttribute('aria-hidden');
            radios.forEach(r=>r.setAttribute('required',''));
          }else{
            row.classList.add('is-hidden');
            row.setAttribute('aria-hidden','true');
            radios.forEach(r=>{
              r.removeAttribute('required');
              r.checked = false;
            });
          }
        });
      }

      function toggleSectionHighlight(section, shouldHighlight){
        if(section){
          section.classList.toggle('expanded', shouldHighlight);
        }
      }

      function updateSummary(){
        const depressionScore = sumScore(PHQ4_DEPRESSION);
        const anxietyScore = sumScore(PHQ4_ANXIETY);
        const showPhq9 = depressionScore >= 3;
        const showGad7 = anxietyScore >= 3;

        setFollowupVisibility(PHQ9_FULL.slice(2), showPhq9);
        setFollowupVisibility(GAD7_FULL.slice(2), showGad7);
        toggleSectionHighlight(phq9Section, showPhq9);
        toggleSectionHighlight(gad7Section, showGad7);

        statusBanner.classList.toggle('show', showPhq9 || showGad7);

        const summaryFrag = document.createDocumentFragment();

        const cards = [
          {
            title: 'PHQ-4 depression sub-score',
            score: depressionScore,
            badge: { text: '≥3 unlocks PHQ-9', active: showPhq9 }
          },
          {
            title: 'PHQ-4 anxiety sub-score',
            score: anxietyScore,
            badge: { text: '≥3 unlocks GAD-7', active: showGad7 }
          }
        ];

        if(showPhq9){
          const phq9Score = sumScore(PHQ9_FULL);
          cards.push({
            title: 'PHQ-9 total score',
            score: phq9Score,
            badge: { text: severityLabel('phq9', phq9Score), active: true }
          });
        }

        if(showGad7){
          const gad7Score = sumScore(GAD7_FULL);
          cards.push({
            title: 'GAD-7 total score',
            score: gad7Score,
            badge: { text: severityLabel('gad7', gad7Score), active: true }
          });
        }

        cards.forEach(card=>{
          const wrapper = document.createElement('div');
          wrapper.className = 'summary-card';
          const h = document.createElement('h3');
          h.textContent = card.title;
          const p = document.createElement('div');
          p.className = 'score';
          p.textContent = card.score;
          wrapper.appendChild(h);
          wrapper.appendChild(p);
          if(card.badge){
            const badge = document.createElement('div');
            badge.className = 'badge' + (card.badge.active ? ' active' : '');
            badge.textContent = card.badge.text;
            wrapper.appendChild(badge);
          }
          summaryFrag.appendChild(wrapper);
        });

        scoreSummary.replaceChildren(summaryFrag);
      }

      function severityLabel(scale, score){
        const band = severityBands[scale].find(b=>score <= b.max);
        return band ? band.label : '';
      }

      function sanitizeHTML(input){
        const tpl=document.createElement('template');
        tpl.innerHTML=String(input ?? '');
        const allowed=new Set(['p','a','b','strong','i','em','u','br','ul','ol','li','code','pre','span']);
        function clean(node){
          if(node.nodeType===Node.TEXT_NODE) return document.createTextNode(node.textContent||'');
          if(node.nodeType!==Node.ELEMENT_NODE) return document.createDocumentFragment();
          const tag=node.tagName.toLowerCase();
          if(['script','style','iframe','object','embed'].includes(tag)) return document.createDocumentFragment();
          if(!allowed.has(tag)){
            const frag=document.createDocumentFragment();
            Array.from(node.childNodes).forEach(c=>frag.appendChild(clean(c)));
            return frag;
          }
          const el=document.createElement(tag);
          if(tag==='a'){
            const href=node.getAttribute('href')||'';
            if(/^https?:\/\//i.test(href)) el.setAttribute('href',href);
            el.setAttribute('target','_blank');
            el.setAttribute('rel','noopener noreferrer');
            if(node.className) el.className=node.className;
          }else if(tag==='span' && node.className){
            el.className=node.className;
          }
          Array.from(node.childNodes).forEach(c=>el.appendChild(clean(c)));
          return el;
        }
        const out=document.createElement('div');
        Array.from(tpl.content.childNodes).forEach(child=>out.appendChild(clean(child)));
        return out.innerHTML;
      }

      function convertDashesToHr(html){
        return html.replace(/<p>\s*-{6,}\s*<\/p>/g,'<hr class="faint">');
      }

      function highlightTargets(){
        const highlightClass='target-highlight';
        resultDiv.querySelectorAll('p').forEach(p=>{
          const text=p.textContent.trim().toLowerCase();
          if(text.includes('refer') || text.includes('escalate')){
            p.classList.add(highlightClass,'risk-level');
          }else if(text.includes('follow-up') || text.includes('monitor')){
            p.classList.add(highlightClass);
          }
        });
      }

      function buildPayload(){
        const formData=new FormData(mhForm);
        const payload={};
        formData.forEach((value,key)=>{ payload[key]=value; });
        payload.phq4_depression=sumScore(PHQ4_DEPRESSION);
        payload.phq4_anxiety=sumScore(PHQ4_ANXIETY);
        if(statusBanner.classList.contains('show')){
          payload.phq9_total=sumScore(PHQ9_FULL);
          payload.gad7_total=sumScore(GAD7_FULL);
        }
        const rating=document.querySelector('input[name="rating"]:checked');
        if(rating) payload.rating=rating.value;
        return payload;
      }

      function buildLocalSummary(){
        const depressionScore=sumScore(PHQ9_FULL);
        const anxietyScore=sumScore(GAD7_FULL);
        const severeItem = mhForm.querySelector('input[name="phq9_q9"]:checked');
        const anyCritical = severeItem && Number(severeItem.value) > 0;
        const items=[];
        if(statusBanner.classList.contains('show')){
          items.push(`<p><strong>PHQ-9 total:</strong> ${depressionScore} (${severityLabel('phq9', depressionScore)})</p>`);
          items.push(`<p><strong>GAD-7 total:</strong> ${anxietyScore} (${severityLabel('gad7', anxietyScore)})</p>`);
        }else{
          items.push(`<p><strong>PHQ-4 depression sub-score:</strong> ${sumScore(PHQ4_DEPRESSION)}</p>`);
          items.push(`<p><strong>PHQ-4 anxiety sub-score:</strong> ${sumScore(PHQ4_ANXIETY)}</p>`);
        }
        if(anyCritical){
          items.push('<p><strong>Safety alert:</strong> Item 9 scores &ge; 1. Ensure immediate safety assessment.</p>');
        }
        return items.join('');
      }

      function copySummary(){
        const payload=buildPayload();
        const now=new Date();
        let text=`HSG Mental Health Screening summary (copied on ${now.toLocaleString()}):\n\n`;
        [...mhForm.querySelectorAll('fieldset[data-question]')].forEach((fs,idx)=>{
          const legend=fs.querySelector('legend');
          const question=legend?legend.textContent.trim().replace(/\s+/g,' '):`Question ${idx+1}`;
          const selected=fs.querySelector('input[type="radio"]:checked');
          let answer='-';
          if(selected){
            const choiceText=selected.closest('label')?.querySelector('.choice-text')?.textContent.trim();
            answer=choiceText || selected.value;
          }
          text+=`${question}\n  ➤ ${answer}\n\n`;
        });
        text+=`Computed scores:\n  • PHQ-4 depression: ${payload.phq4_depression}\n  • PHQ-4 anxiety: ${payload.phq4_anxiety}`;
        if(payload.phq9_total!==undefined) text+=`\n  • PHQ-9 total: ${payload.phq9_total}`;
        if(payload.gad7_total!==undefined) text+=`\n  • GAD-7 total: ${payload.gad7_total}`;
        navigator.clipboard.writeText(text).then(()=>{
          copyBtn.textContent='Copied!';
          setTimeout(()=>{copyBtn.textContent='Copy summary';},1800);
        }).catch(()=>{
          alert('Failed to copy. Please copy manually.');
        });
      }

      function clearAll(){
        mhForm.reset();
        resultDiv.innerHTML='';
        copyBtn.style.display='none';
        clearBtn.style.display='none';
        statusBanner.classList.remove('show');
        setFollowupVisibility(PHQ9_FULL.slice(2), false);
        setFollowupVisibility(GAD7_FULL.slice(2), false);
        toggleSectionHighlight(phq9Section, false);
        toggleSectionHighlight(gad7Section, false);
        updateSummary();
        try{ window.scrollTo({top:0,behavior:'smooth'});}catch{window.scrollTo(0,0);}
      }

      function renderResult(sections){
        const frag=document.createDocumentFragment();
        sections.forEach(section=>{
          const wrapper=document.createElement('div');
          wrapper.innerHTML=`<h4>${section.title}</h4>${section.body}`;
          frag.appendChild(wrapper);
        });
        resultDiv.replaceChildren(Object.assign(document.createElement('h3'),{className:'section-head',textContent:'Summary'}),frag);
        highlightTargets();
        copyBtn.style.display='inline-block';
        clearBtn.style.display='inline-block';
      }

      async function handleSubmit(event){
        event.preventDefault();
        if(!mhForm.reportValidity || mhForm.reportValidity()){
          submitBtn.disabled=true;
          resultDiv.innerHTML='';
          const payload=buildPayload();
          try{
            const res=await fetch('/api/mental-health',{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify(payload)
            });
            const rawText=await res.text();
            let json;
            try{ json=JSON.parse(rawText);}catch{
              const match=rawText.match(/\{[\s\S]*\}$/);
              if(match){
                json=JSON.parse(match[0]);
              }
            }
            if(res.ok && json){
              const sections=[];
              Object.entries(json).forEach(([key,value])=>{
                if(typeof value==='string'){
                  const looksHTML=/<\s*([a-z]+)(\s|>)/i.test(value);
                  const body=looksHTML?convertDashesToHr(sanitizeHTML(value)):`<p>${value}</p>`;
                  sections.push({title:key.replace(/_/g,' '), body});
                }else{
                  sections.push({title:key.replace(/_/g,' '), body:`<pre>${sanitizeHTML(JSON.stringify(value,null,2))}</pre>`});
                }
              });
              if(sections.length){
                renderResult(sections);
              }else{
                renderResult([{title:'Local summary', body:buildLocalSummary()}]);
                resultDiv.appendChild(Object.assign(document.createElement('div'),{className:'api-success',textContent:'API responded without actionable payload. Displaying computed summary instead.'}));
              }
            }else{
              renderResult([{title:'Local summary', body:buildLocalSummary()}]);
              const errorBox=document.createElement('div');
              errorBox.className='api-error';
              errorBox.textContent='Unable to retrieve recommendations from the API. Local score summary is shown.';
              resultDiv.appendChild(errorBox);
            }
          }catch(err){
            console.error(err);
            renderResult([{title:'Local summary', body:buildLocalSummary()}]);
            const errorBox=document.createElement('div');
            errorBox.className='api-error';
            errorBox.textContent='Network error while contacting the API. Local score summary is shown.';
            resultDiv.appendChild(errorBox);
          }finally{
            submitBtn.disabled=false;
          }
        }
      }

      mhForm.addEventListener('change', updateSummary, {capture:true});
      mhForm.addEventListener('submit', handleSubmit);
      copyBtn.addEventListener('click', copySummary);
      clearBtn.addEventListener('click', clearAll);

      document.querySelectorAll('input[name="rating"]').forEach(radio=>{
        radio.addEventListener('change',()=>{
          const thanks=document.getElementById('rateThanks');
          thanks.classList.add('show');
          setTimeout(()=>thanks.classList.remove('show'),3200);
        });
      });

      updateSummary();
    </script>
  </body>
</html>
